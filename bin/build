#!/bin/bash
set -e

CLONED_SOURCE_PACKAGES_DIR_PATH=".build"    # This matches spm location `swift run` uses
DERIVED_DATA_PATH=".build/DerivedData"

# Retrieve platform as first argument converted to lowercase
PLATFORM=$(echo "$1" | tr '[:upper:]' '[:lower:]')

# Replace 'os' with 'OS' in platform name
# this allows input to be `bin/build ios` or `bin/build iOS`
PLATFORM=${PLATFORM/os/OS}

# Verify that platform is present, exit with error if not
if [ -z "$PLATFORM" ] ; then
    echo "Platform is required as first argument:"
    echo "      bin/build <platform>"
    exit 1
fi

# Validate platform as one of 'iOS', 'macOS', 'watchOS', 'tvOS'
if [ "$PLATFORM" != "iOS" ] && [ "$PLATFORM" != "macOS" ] && [ "$PLATFORM" != "watchOS" ] && [ "$PLATFORM" != "tvOS" ]; then
    echo "Invalid platform '$PLATFORM'"
    echo "Must be one of: 'iOS', 'macOS', 'watchOS', 'tvOS'"
    exit 1
fi

xcodebuild \
    -workspace . \
    -configuration "Release" \
    -scheme "EmbraceIO-Package" \
    -destination "generic/platform=$PLATFORM" \
    -clonedSourcePackagesDirPath $CLONED_SOURCE_PACKAGES_DIR_PATH \
    -skipPackagePluginValidation \
    -derivedDataPath $DERIVED_DATA_PATH \
    clean build
